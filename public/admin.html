<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Dashboard | Ndola Homes</title>
  <link rel="icon" type="image/svg+xml" href="/public/favicon.svg">
  <link rel="icon" type="image/x-icon" href="/public/favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="/public/styles.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg">
  <div class="container">
    <a class="navbar-brand" href="/">
      <i class="fas fa-home me-2"></i>Ndola Homes
    </a>
    <div class="d-flex">
      <a href="/" class="btn btn-outline-primary btn-sm me-2">
        <i class="fas fa-arrow-left me-1"></i>Back to Site
      </a>
      <span class="badge bg-success">Admin Panel</span>
    </div>
  </div>
</nav>

<main class="container my-5" id="adminRoot" style="display:none">
  <div class="row">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header d-flex align-items-center">
          <i class="fas fa-plus-circle me-2 text-primary"></i>
          <span>Add New Property Listing</span>
        </div>
        <div class="card-body">
  <form id="listingForm" class="row g-3" enctype="multipart/form-data">
            <div class="col-md-6">
              <label class="form-label">Property Title</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-home"></i></span>
                <input class="form-control" name="title" placeholder="e.g., Beautiful 3-bedroom house in Riverside" required>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">City</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                <input class="form-control" name="city" placeholder="City" value="Ndola" required>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Area/Suburb</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-location-dot"></i></span>
                <input class="form-control" name="area" placeholder="e.g., Riverside, Town Centre">
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Full Address</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-map"></i></span>
                <input class="form-control" name="address" placeholder="Street address">
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Price (ZMW)</label>
              <div class="input-group">
                <span class="input-group-text">ZMW</span>
                <input class="form-control" name="price" placeholder="0" type="number" required>
              </div>
            </div>
    <div class="col-md-4">
              <label class="form-label">Property Type</label>
      <select class="form-select" name="type">
                <option value="rent">For Rent</option>
                <option value="sale">For Sale</option>
      </select>
    </div>
            <div class="col-md-2">
              <label class="form-label">Bedrooms</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-bed"></i></span>
                <input class="form-control" name="bedrooms" placeholder="0" type="number">
              </div>
            </div>
            <div class="col-md-2">
              <label class="form-label">Bathrooms</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-bath"></i></span>
                <input class="form-control" name="bathrooms" placeholder="0" type="number">
              </div>
            </div>
            <div class="col-12">
              <label class="form-label">Property Description</label>
              <textarea class="form-control" name="description" placeholder="Describe the property features, amenities, and what makes it special..." rows="4" required></textarea>
            </div>
            <div class="col-12">
              <h6 class="mt-2">Owner / Agent Details</h6>
            </div>
            <div class="col-md-4">
              <label class="form-label">Owner/Agent Name</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-user"></i></span>
                <input class="form-control" name="owner_name" placeholder="Full name">
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Owner/Agent Email</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                <input class="form-control" type="email" name="owner_email" placeholder="name@example.com">
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Owner/Agent Phone</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-phone"></i></span>
                <input class="form-control" name="owner_phone" placeholder="+260 ...">
              </div>
            </div>
            <div class="col-12">
              <h6 class="mt-2">Location</h6>
            </div>
            <div class="col-md-5">
              <label class="form-label">Latitude</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-globe-africa"></i></span>
                <input class="form-control" name="latitude" id="latitude" placeholder="-12.97">
              </div>
            </div>
            <div class="col-md-5">
              <label class="form-label">Longitude</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-globe"></i></span>
                <input class="form-control" name="longitude" id="longitude" placeholder="28.64">
              </div>
            </div>
            <div class="col-md-2 d-grid">
              <label class="form-label">&nbsp;</label>
              <button type="button" class="btn btn-outline-primary" id="useMyLocation">
                <i class="fas fa-location-crosshairs me-1"></i>Use my location
              </button>
            </div>
    <div class="col-12">
              <label class="form-label">Photos & Videos</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-camera"></i></span>
      <input class="form-control" name="media" type="file" multiple accept="image/*,video/*">
              </div>
              <div class="form-text">Upload multiple photos and videos to showcase the property</div>
    </div>
    <div class="col-12">
              <button class="btn btn-primary btn-lg" type="submit">
                <i class="fas fa-plus me-2"></i>Create Listing
              </button>
              <span id="status" class="ms-3 small"></span>
    </div>
  </form>
        </div>
      </div>
    </div>
    
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header d-flex align-items-center">
          <i class="fas fa-chart-bar me-2 text-success"></i>
          <span>Quick Stats</span>
        </div>
        <div class="card-body">
          <div class="stat-item mb-3">
            <div class="d-flex justify-content-between">
              <span class="small">Total Listings</span>
              <strong class="text-primary" id="totalListings">0</strong>
            </div>
          </div>
          <div class="stat-item mb-3">
            <div class="d-flex justify-content-between">
              <span class="small">Active Listings</span>
              <strong class="text-success" id="activeListings">0</strong>
            </div>
          </div>
          <div class="stat-item mb-3">
            <div class="d-flex justify-content-between">
              <span class="small">For Rent</span>
              <strong class="text-warning" id="rentListings">0</strong>
            </div>
          </div>
          <div class="stat-item">
            <div class="d-flex justify-content-between">
              <span class="small">For Sale</span>
              <strong class="text-info" id="saleListings">0</strong>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card mt-3">
        <div class="card-header d-flex align-items-center">
          <i class="fas fa-lightbulb me-2 text-warning"></i>
          <span>Tips</span>
        </div>
        <div class="card-body">
          <ul class="list-unstyled small">
            <li class="mb-2">
              <i class="fas fa-check text-success me-2"></i>
              Use high-quality photos
            </li>
            <li class="mb-2">
              <i class="fas fa-check text-success me-2"></i>
              Write detailed descriptions
            </li>
            <li class="mb-2">
              <i class="fas fa-check text-success me-2"></i>
              Include all amenities
            </li>
            <li>
              <i class="fas fa-check text-success me-2"></i>
              Set competitive pricing
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(async function enforceAuth(){
  const token = localStorage.getItem('auth_token');
  if (!token){
    showAuthModal();
    return;
  }
  try {
    const res = await fetch('/api/auth/me',{ headers: { 'Authorization': 'Bearer ' + token } });
    if (!res.ok) throw new Error('unauthorized');
    const data = await res.json();
    if (!['agent','admin'].includes(data.user.role)){
      showNotification('You need an agent or admin account to access this page.','danger');
      showAuthModal();
      return;
    }
    document.getElementById('adminRoot').style.display = '';
    loadStats();
  } catch(err){
    showAuthModal();
  }
})();

// Load and display listing statistics
async function loadStats() {
  try {
    const res = await fetch('/api/listings?limit=1000');
    if (res.ok) {
      const data = await res.json();
      const listings = data.items || [];
      
      const totalListings = listings.length;
      const activeListings = listings.length; // All listings are considered active
      const rentListings = listings.filter(l => l.type === 'rent').length;
      const saleListings = listings.filter(l => l.type === 'sale').length;
      
      document.getElementById('totalListings').textContent = totalListings;
      document.getElementById('activeListings').textContent = activeListings;
      document.getElementById('rentListings').textContent = rentListings;
      document.getElementById('saleListings').textContent = saleListings;
    }
  } catch (error) {
    console.error('Error loading stats:', error);
  }
}

document.getElementById('listingForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const data = new FormData(form);
  const status = document.getElementById('status');
  const submitBtn = form.querySelector('button[type="submit"]');
  
  // Show loading state
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating...';
  status.textContent = 'Uploading property details...';
  
  try {
    const token = localStorage.getItem('auth_token');
    const res = await fetch('/api/listings', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token }, body: data });
    
    if (res.ok) {
      status.innerHTML = '<i class="fas fa-check text-success me-1"></i>Listing created successfully!';
      form.reset();
      showNotification('Property listing created successfully!', 'success');
      loadStats(); // Refresh statistics after adding new listing
    } else {
      status.innerHTML = '<i class="fas fa-times text-danger me-1"></i>Failed to create listing.';
      showNotification('Failed to create listing. Please try again.', 'danger');
    }
  } catch (error) {
    status.innerHTML = '<i class="fas fa-times text-danger me-1"></i>Network error.';
    showNotification('Network error. Please check your connection.', 'danger');
  } finally {
    // Reset button state
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="fas fa-plus me-2"></i>Create Listing';
  }
});
function showAuthModal(){
  const html = `
    <div class='modal fade' id='authModal' tabindex='-1'>
      <div class='modal-dialog'>
        <div class='modal-content'>
          <div class='modal-header'>
            <h5 class='modal-title'>Sign in to access Admin</h5>
            <button type='button' class='btn-close' data-bs-dismiss='modal'></button>
          </div>
          <div class='modal-body'>
            <ul class="nav nav-tabs" id="authTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#loginPane" type="button" role="tab">Login</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#registerPane" type="button" role="tab">Register Admin</button>
              </li>
            </ul>
            <div class="tab-content pt-3">
              <div class="tab-pane fade show active" id="loginPane" role="tabpanel">
                <div class="mb-3"><input id="loginEmail" class="form-control" type="email" placeholder="Email"></div>
                <div class="mb-3"><input id="loginPassword" class="form-control" type="password" placeholder="Password"></div>
                <button id="loginBtn" class="btn btn-primary w-100">Login</button>
              </div>
              <div class="tab-pane fade" id="registerPane" role="tabpanel">
                <div class="mb-3"><input id="regName" class="form-control" placeholder="Full name"></div>
                <div class="mb-3"><input id="regEmail" class="form-control" type="email" placeholder="Email"></div>
                <div class="mb-3"><input id="regPassword" class="form-control" type="password" placeholder="Password (min 6 chars)"></div>
                <button id="registerBtn" class="btn btn-success w-100">Create account</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>`;
  const wrapper = document.createElement('div');
  wrapper.innerHTML = html;
  document.body.appendChild(wrapper);
  const modal = new bootstrap.Modal(wrapper.querySelector('#authModal'));
  modal.show();
  wrapper.addEventListener('hidden.bs.modal', () => wrapper.remove());

  wrapper.querySelector('#loginBtn').addEventListener('click', async ()=>{
    const email = wrapper.querySelector('#loginEmail').value;
    const password = wrapper.querySelector('#loginPassword').value;
    const res = await fetch('/api/auth/login',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, password })});
    if (res.ok){
      const data = await res.json();
      localStorage.setItem('auth_token', data.token);
      showNotification('Logged in successfully','success');
      modal.hide();
      location.reload();
    } else {
      showNotification('Login failed','danger');
    }
  });
  wrapper.querySelector('#registerBtn').addEventListener('click', async ()=>{
    const name = wrapper.querySelector('#regName').value;
    const email = wrapper.querySelector('#regEmail').value;
    const password = wrapper.querySelector('#regPassword').value;
    const res = await fetch('/api/auth/register-admin',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, email, password })});
    if (res.ok){
      const data = await res.json();
      localStorage.setItem('auth_token', data.token);
      showNotification('Admin account created and logged in','success');
      modal.hide();
      location.reload();
    } else {
      const errorData = await res.json().catch(() => ({}));
      if (res.status === 409 && errorData.error === 'email_in_use') {
        showNotification('Email already in use. Please try logging in instead.','warning');
      } else {
        showNotification('Registration failed. Please check your details and try again.','danger');
      }
    }
  });
}

function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
  notification.style.cssText = 'top: 100px; right: 20px; z-index: 9999; min-width: 300px;';
  notification.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    if (notification.parentNode) {
      notification.remove();
    }
  }, 5000);
}

// Geolocation helper to auto-fill lat/lon
document.getElementById('useMyLocation').addEventListener('click', () => {
  if (!navigator.geolocation) {
    showNotification('Geolocation is not supported by your browser.', 'warning');
    return;
  }
  const btn = document.getElementById('useMyLocation');
  const prev = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Locating...';
  navigator.geolocation.getCurrentPosition((pos) => {
    const { latitude, longitude } = pos.coords;
    document.getElementById('latitude').value = latitude.toFixed(6);
    document.getElementById('longitude').value = longitude.toFixed(6);
    showNotification('Location captured successfully.', 'success');
    btn.disabled = false;
    btn.innerHTML = prev;
  }, (err) => {
    showNotification('Failed to get location: ' + err.message, 'danger');
    btn.disabled = false;
    btn.innerHTML = prev;
  }, { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 });
});
</script>
</body>
</html>


